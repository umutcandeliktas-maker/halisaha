<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HalÄ± Saha Pro - CTRL Ã‡oklu SeÃ§im</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .field-container { position: relative; margin: 20px auto; width: fit-content; }
    .field {
      position: relative;
      width: 1000px;
      height: 500px;
      background-color: #15803d;
      border: 5px solid white;
      border-radius: 12px;
      overflow: hidden;
      touch-action: none;
    }
    .line { position: absolute; background: white; }
    .center-line { top: 0; left: 50%; width: 2px; height: 100%; transform: translateX(-50%); }
    .center-circle { top: 50%; left: 50%; width: 100px; height: 100px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); }
    .goal { position: absolute; width: 15px; height: 120px; border: 3px solid white; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); }
    
    .player {
      position: absolute;
      padding: 8px 18px;
      border-radius: 50px;
      font-weight: bold;
      color: black;
      cursor: grab;
      z-index: 10;
      white-space: nowrap;
      border: 2px solid rgba(0,0,0,0.2);
      user-select: none;
    }
    /* SEÃ‡Ä°LÄ° OYUNCU STÄ°LÄ° */
    .player.selected {
      outline: 4px solid white;
      box-shadow: 0 0 20px rgba(255,255,255,0.6);
      z-index: 20;
    }
    .player:active { cursor: grabbing; }
    
    .helper-text {
      text-align: center;
      color: #94a3b8;
      font-size: 0.875rem;
      margin-top: 10px;
    }
  </style>
</head>
<body class="bg-slate-900 text-white font-sans">

<header class="bg-slate-800 text-center text-2xl font-black py-4 border-b-4 border-indigo-500 shadow-2xl">
  âš½ Ã‡OKLU SEÃ‡Ä°M VE HÄ°ZALAMA MODU
</header>

<div class="container mx-auto p-4">
  <div class="bg-slate-800 p-4 rounded-xl mb-6 flex flex-wrap gap-4 items-center justify-between shadow-lg">
    <div class="flex gap-4">
      <select id="playerCount" class="bg-slate-700 p-2 rounded-lg outline-none border border-slate-600"></select>
      <button onclick="generatePlayers()" class="bg-indigo-600 px-4 py-2 rounded-lg font-bold">LÄ°STEYÄ° OLUÅžTUR</button>
      <button onclick="clearCache()" class="bg-red-600 px-4 py-2 rounded-lg font-bold">SIFIRLA</button>
    </div>
    <div class="flex gap-3">
      <button onclick="createTeams()" class="bg-yellow-500 text-black px-8 py-2 rounded-full font-black">SAHAYA DÄ°Z</button>
      <button onclick="shareImage()" class="bg-green-600 px-6 py-2 rounded-full font-bold">RESMÄ° Ä°NDÄ°R</button>
    </div>
  </div>

  <div id="players" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"></div>

  <div class="field-container">
    <div id="tacticalField" class="field">
      <div class="center-line"></div><div class="center-circle"></div>
      <div class="goal" style="left:-6px;"></div><div class="goal" style="right:-6px;"></div>
    </div>
    <p class="helper-text">ðŸ’¡ <b>Taktik:</b> Birden fazla oyuncu seÃ§mek iÃ§in <b>CTRL</b> tuÅŸuna basÄ±lÄ± tutarak tÄ±klayÄ±n. Birini sÃ¼rÃ¼kleyince hepsi aynÄ± hizada hareket eder.</p>
  </div>
</div>

<script>
let players = [];
let selectedElements = [];
const STORAGE_KEY = 'halisaha_v7_ctrl';

document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('playerCount');
  for (let i = 2; i <= 22; i++) {
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = i + " Oyuncu";
    if(i === 14) opt.selected = true;
    select.appendChild(opt);
  }
  if (localStorage.getItem(STORAGE_KEY)) {
    players = JSON.parse(localStorage.getItem(STORAGE_KEY));
    renderPlayers();
  }
});

function generatePlayers() {
  const count = Number(document.getElementById('playerCount').value);
  players = [];
  for (let i = 1; i <= count; i++) players.push({ name: `Oyuncu ${i}`, roles: [] });
  save(); renderPlayers();
}

function renderPlayers() {
  const div = document.getElementById('players');
  div.innerHTML = '';
  players.forEach((p, i) => {
    const card = document.createElement('div');
    card.className = 'bg-slate-800 p-3 rounded-xl border border-slate-700 shadow-md';
    card.innerHTML = `
      <input value="${p.name}" onchange="players[${i}].name=this.value;save()" class="bg-slate-900 text-white p-2 rounded-lg w-full mb-2 outline-none border border-slate-700">
      <div class="flex gap-1">
        ${['GK','DEF','MID','FWD'].map(role => `
          <button onclick="toggleRole(${i},'${role}')" class="flex-1 text-[10px] py-2 rounded-md ${p.roles.includes(role)?'bg-indigo-500 text-white':'bg-slate-700 text-slate-400'}">${role}</button>
        `).join('')}
      </div>
    `;
    div.appendChild(card);
  });
}

function toggleRole(idx, role) {
  const p = players[idx];
  p.roles.includes(role) ? p.roles = p.roles.filter(r => r!==role) : p.roles.push(role);
  save(); renderPlayers();
}

function createTeams() {
  const field = document.getElementById('tacticalField');
  const lines = field.querySelectorAll('.center-line, .center-circle, .goal');
  field.innerHTML = '';
  lines.forEach(l => field.appendChild(l));
  selectedElements = [];

  const teamA = [], teamB = [];
  players.forEach((p, idx) => (idx % 2 === 0) ? teamA.push(p) : teamB.push(p));

  const posMap = {
    GK: { x: 5, y: 46 },
    DEF: [{x:18, y:18}, {x:18, y:46}, {x:18, y:74}],
    MID: [{x:35, y:28}, {x:35, y:64}],
    FWD: { x: 46, y: 46 }
  };

  const drawTeam = (team, color, isLeft) => {
    let counters = { DEF: 0, MID: 0 };
    team.forEach(p => {
      const el = document.createElement('div');
      const role = p.roles.length > 0 ? p.roles[0] : 'MID';
      el.className = 'player';
      el.textContent = p.name;
      el.style.backgroundColor = color;

      let coords = { x: 50, y: 50 };
      if(p.roles.includes('GK')) coords = posMap.GK;
      else if(p.roles.includes('FWD')) coords = posMap.FWD;
      else if(p.roles.includes('DEF')) { coords = posMap.DEF[counters.DEF % 3]; counters.DEF++; }
      else { coords = posMap.MID[counters.MID % 2]; counters.MID++; }

      el.style.left = (isLeft ? coords.x : (100 - coords.x - 4)) + "%";
      el.style.top = coords.y + "%";
      
      // TÄ±klama ile SeÃ§im KontrolÃ¼
      el.addEventListener('mousedown', (e) => {
        if (e.ctrlKey) {
          e.preventDefault();
          if (el.classList.contains('selected')) {
            el.classList.remove('selected');
            selectedElements = selectedElements.filter(item => item !== el);
          } else {
            el.classList.add('selected');
            selectedElements.push(el);
          }
        } else if (!el.classList.contains('selected')) {
          // CTRL basÄ±lÄ± deÄŸilse ve seÃ§ili olmayan birine tÄ±klandÄ±ysa diÄŸerlerini bÄ±rak
          selectedElements.forEach(item => item.classList.remove('selected'));
          selectedElements = [el];
          el.classList.add('selected');
        }
      });

      makeDraggable(el);
      field.appendChild(el);
    });
  };

  drawTeam(teamA, '#fbbf24', true);
  drawTeam(teamB, '#22d3ee', false);
}

function makeDraggable(el) {
  let isDragging = false;
  let startPositions = [];

  const start = (e) => {
    if (e.ctrlKey) return; // SeÃ§im yaparken sÃ¼rÃ¼klemeyi baÅŸlatma
    isDragging = true;
    const cx = e.clientX;
    const cy = e.clientY;

    // SÃ¼rÃ¼kleme baÅŸladÄ±ÄŸÄ±nda seÃ§ili tÃ¼m oyuncularÄ±n baÅŸlangÄ±Ã§ konumlarÄ±nÄ± kaydet
    startPositions = selectedElements.map(item => ({
      el: item,
      left: item.offsetLeft,
      top: item.offsetTop,
      startX: cx,
      startY: cy
    }));
  };

  const move = (e) => {
    if (!isDragging) return;
    const cx = e.clientX;
    const cy = e.clientY;
    const fRect = document.getElementById('tacticalField').getBoundingClientRect();

    startPositions.forEach(pos => {
      const dx = cx - pos.startX;
      const dy = cy - pos.startY;
      
      let nx = pos.left + dx;
      let ny = pos.top + dy;

      // SÄ±nÄ±r koruma
      nx = Math.max(0, Math.min(nx, fRect.width - pos.el.offsetWidth));
      ny = Math.max(0, Math.min(ny, fRect.height - pos.el.offsetHeight));

      pos.el.style.left = nx + "px";
      pos.el.style.top = ny + "px";
    });
  };

  const end = () => { isDragging = false; };

  el.addEventListener('mousedown', start);
  window.addEventListener('mousemove', move);
  window.addEventListener('mouseup', end);
}

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(players)); }
function clearCache() { if(confirm("SÄ±fÄ±rlansÄ±n mÄ±?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
function shareImage() {
  const field = document.getElementById('tacticalField');
  // FotoÄŸraf Ã§ekerken seÃ§ili beyaz Ã§izgileri gizle
  const selecteds = field.querySelectorAll('.selected');
  selecteds.forEach(s => s.classList.remove('selected'));
  
  html2canvas(field, { backgroundColor: '#15803d' }).then(canvas => {
    const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download = 'taktik-kurulu.png'; a.click();
    selecteds.forEach(s => s.classList.add('selected')); // Geri ekle
  });
}
</script>
</body>
</html>
