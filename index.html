<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taktik Pro - Fizik Motorlu</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .field-container { position: relative; margin: 20px auto; width: fit-content; padding: 20px; }
    .field {
      position: relative;
      width: 1100px; height: 650px;
      background-color: #1a8a42;
      border: 5px solid white; border-radius: 12px;
      overflow: hidden;
      resize: both;
      min-width: 800px; min-height: 500px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .line { position: absolute; background: rgba(255,255,255,0.8); }
    .center-line { top: 0; left: 50%; width: 2px; height: 100%; transform: translateX(-50%); }
    .center-circle { top: 50%; left: 50%; width: 140px; height: 140px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); }
    .goal-post { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 180px; border: 4px solid white; background: rgba(255,255,255,0.1); z-index: 2; }
    .goal-l { left: -5px; border-left: none; }
    .goal-r { right: -5px; border-right: none; }
    .pen-box { position: absolute; border: 2px solid white; top: 50%; transform: translateY(-50%); height: 380px; width: 150px; }
    
    .player {
      position: absolute; width: 110px; padding: 12px 5px; border-radius: 20px;
      font-weight: bold; color: black; cursor: grab; z-index: 10; text-align: center;
      border: 2px solid rgba(0,0,0,0.3); user-select: none; font-size: 13px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4); transform: translate(-50%, -50%);
      pointer-events: auto;
    }
    .player.selected { outline: 4px solid gold; box-shadow: 0 0 20px gold; z-index: 100; }
    .ball {
      position: absolute; width: 38px; height: 38px; background: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; z-index: 60;
      box-shadow: 0 4px 15px rgba(0,0,0,0.6); cursor: grab; transform: translate(-50%, -50%);
      font-size: 22px;
    }
  </style>
</head>
<body class="bg-slate-900 text-white font-sans">

<header class="bg-slate-800 text-center py-6 border-b-4 border-green-600 shadow-xl">
  <h1 class="text-3xl font-black italic tracking-tighter">‚öΩ TAKTƒ∞K PRO v8.8 (Fizik Motorlu)</h1>
</header>

<div class="container mx-auto p-4">
  <div class="bg-slate-800 p-6 rounded-2xl mb-8 flex flex-wrap gap-6 items-center justify-between border border-slate-700 shadow-2xl">
    <div class="flex items-center gap-4">
      <select id="pCount" class="bg-slate-700 p-3 rounded-xl outline-none border border-slate-600 font-bold text-green-400 w-40"></select>
      <button onclick="initPlayers()" class="bg-indigo-600 px-6 py-3 rounded-xl font-bold hover:bg-indigo-500">YENƒ∞ KADRO</button>
    </div>
    <div class="flex gap-4">
      <button onclick="drawTactics()" class="bg-yellow-500 text-black px-12 py-4 rounded-full font-black shadow-lg hover:scale-105 transition-all">üèüÔ∏è SAHAYA Dƒ∞Z</button>
      <button onclick="saveField()" class="bg-green-600 px-8 py-4 rounded-full font-bold hover:bg-green-500 transition-all shadow-lg">üì∏ KAYDET</button>
    </div>
  </div>

  <div id="playerList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-10"></div>

  <div class="field-container">
    <div id="field" class="field">
      <div class="line center-line"></div>
      <div class="center-circle"></div>
      <div class="goal-post goal-l"></div>
      <div class="goal-post goal-r"></div>
      <div class="pen-box" style="left:0; border-left:none;"></div>
      <div class="pen-box" style="right:0; border-right:none;"></div>
      <div class="ball" id="ball" style="left: 50%; top: 50%;">‚öΩ</div>
    </div>
  </div>
</div>

<script>
let squad = [];
const KEY = 'taktik_pro_v88';
const SAFE_DISTANCE = 85; // Oyuncularƒ±n birbirine yakla≈üabileceƒüi minimum piksel

const layoutA = { 
  GK: [{x:7, y:50}], 
  DEF: [{x:20, y:50}, {x:22, y:20}, {x:22, y:80}], 
  MID: [{x:35, y:35}, {x:35, y:65}], 
  FWD: [{x:46, y:50}] 
};

const layoutB = { 
  GK: [{x:93, y:50}], 
  DEF: [{x:80, y:20}, {x:80, y:80}], 
  MID: [{x:68, y:30}, {x:68, y:50}, {x:68, y:70}], 
  FWD: [{x:56, y:50}] 
};

document.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('pCount');
  for (let i = 2; i <= 22; i+=2) {
    let o = document.createElement('option');
    o.value = i; o.textContent = `${i} Oyuncu`;
    if(i===14) o.selected = true;
    sel.appendChild(o);
  }
  const saved = localStorage.getItem(KEY);
  if (saved) squad = JSON.parse(saved); else initPlayers();
  renderList();
  drag(document.getElementById('ball'));
});

function initPlayers() {
  const n = Number(document.getElementById('pCount').value);
  squad = Array.from({length: n}, (_, i) => ({ id: i, name: `Oyuncu ${i+1}`, roles: [] }));
  localStorage.setItem(KEY, JSON.stringify(squad));
  renderList();
}

function renderList() {
  const container = document.getElementById('playerList');
  container.innerHTML = squad.map((p, i) => `
    <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
      <input onchange="squad[${i}].name=this.value; localStorage.setItem(KEY, JSON.stringify(squad))" value="${p.name}" class="bg-slate-900 text-white p-2 w-full rounded mb-2 text-sm outline-none">
      <div class="grid grid-cols-4 gap-1">
        ${['GK','DEF','MID','FWD'].map(r => `
          <button onclick="toggleRole(${i},'${r}')" class="text-[9px] py-1 rounded ${p.roles.includes(r)?'bg-indigo-600':'bg-slate-700'}">${r}</button>
        `).join('')}
      </div>
    </div>
  `).join('');
}

function toggleRole(i, r) {
  if(squad[i].roles.includes(r)) squad[i].roles = squad[i].roles.filter(x => x!==r);
  else squad[i].roles.push(r);
  localStorage.setItem(KEY, JSON.stringify(squad));
  renderList();
}

function drawTactics() {
  const f = document.getElementById('field');
  f.querySelectorAll('.player').forEach(p => p.remove());
  document.getElementById('ball').style.left = "50%";
  document.getElementById('ball').style.top = "50%";

  const teamA = squad.slice(0, squad.length/2);
  const teamB = squad.slice(squad.length/2);

  const place = (team, config, color) => {
    let counts = { GK:0, DEF:0, MID:0, FWD:0 };
    team.forEach((p) => {
      const el = document.createElement('div');
      el.className = 'player';
      el.textContent = p.name;
      el.style.backgroundColor = color;
      let role = p.roles[0] || (counts.GK<1?'GK': counts.DEF<3?'DEF': counts.MID<3?'MID': 'FWD');
      let posBase = config[role] ? config[role][counts[role] % config[role].length] : {x:50, y:50};
      el.style.left = posBase.x + "%";
      el.style.top = (posBase.y + (counts[role]*2)) + "%";
      counts[role]++;
      drag(el);
      f.appendChild(el);
    });
  };
  place(teamA, layoutA, '#f3a616');
  place(teamB, layoutB, '#43d1f0');
}

function drag(el) {
  let active = false, startX, startY, initX, initY;

  const evStart = (e) => {
    active = true;
    const c = e.touches ? e.touches[0] : e;
    startX = c.clientX; startY = c.clientY;
    initX = el.offsetLeft; initY = el.offsetTop;
    document.querySelectorAll('.player').forEach(p => p.classList.remove('selected'));
    el.classList.add('selected');
    e.preventDefault();
  };

  const evMove = (e) => {
    if (!active) return;
    const c = e.touches ? e.touches[0] : e;
    const nextX = initX + (c.clientX - startX);
    const nextY = initY + (c.clientY - startY);

    // √áARPI≈ûMA KONTROL√ú (Collision Detection)
    let canMove = true;
    if (el.classList.contains('player')) {
      const others = document.querySelectorAll('.player');
      others.forEach(other => {
        if (other === el) return;
        const dx = nextX - other.offsetLeft;
        const dy = nextY - other.offsetTop;
        const distance = Math.sqrt(dx*dx + dy*dy);
        if (distance < SAFE_DISTANCE) canMove = false;
      });
    }

    if (canMove) {
      el.style.left = nextX + "px";
      el.style.top = nextY + "px";
    }
  };

  const evEnd = () => active = false;

  el.addEventListener('mousedown', evStart);
  window.addEventListener('mousemove', evMove);
  window.addEventListener('mouseup', evEnd);
  el.addEventListener('touchstart', evStart, {passive:false});
  window.addEventListener('touchmove', evMove, {passive:false});
  window.addEventListener('touchend', evEnd);
}

function saveField() {
  html2canvas(document.getElementById('field'), {backgroundColor:'#1a8a42'}).then(canvas => {
    const link = document.createElement('a');
    link.download = 'taktik-pro-final.png';
    link.href = canvas.toDataURL();
    link.click();
  });
}
</script>
</body>
</html>
